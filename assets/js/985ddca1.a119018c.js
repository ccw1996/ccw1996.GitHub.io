"use strict";(self.webpackChunkblog_sample=self.webpackChunkblog_sample||[]).push([[499],{7098:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var o=e(5893),i=e(1151);const s={title:"onnx \u81ea\u5b9a\u4e49op\u5e76\u5bfc\u51fa",tags:["work","interview"]},r=void 0,a={id:"ml/optimization/custom_onnx_op",title:"onnx \u81ea\u5b9a\u4e49op\u5e76\u5bfc\u51fa",description:"https://blog.csdn.net/u011622208/article/details/122255317",source:"@site/docs/ml/optimization/custom_onnx_op.md",sourceDirName:"ml/optimization",slug:"/ml/optimization/custom_onnx_op",permalink:"/docs/ml/optimization/custom_onnx_op",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/ml/optimization/custom_onnx_op.md",tags:[{label:"work",permalink:"/docs/tags/work"},{label:"interview",permalink:"/docs/tags/interview"}],version:"current",lastUpdatedAt:1704643201,formattedLastUpdatedAt:"Jan 7, 2024",frontMatter:{title:"onnx \u81ea\u5b9a\u4e49op\u5e76\u5bfc\u51fa",tags:["work","interview"]},sidebar:"tutorialSidebar",previous:{title:"AudioLDM 2\uff0c\u52a0\u901f",permalink:"/docs/ml/optimization/SD\u6a21\u578b\u4f18\u5316"},next:{title:"\u518d\u6b21\u7406\u89e3 im2col",permalink:"/docs/ml/optimization/im2col"}},c={},l=[];function p(n){const t={a:"a",blockquote:"blockquote",code:"code",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.blockquote,{children:["\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.a,{href:"https://blog.csdn.net/u011622208/article/details/122255317",children:"https://blog.csdn.net/u011622208/article/details/122255317"})}),"\n"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"import torch\nimport torch.nn as nn\nfrom torch.autograd import Function\nimport onnx\nimport torch.onnx\n\nclass Requant_(Function):\n    @staticmethod\n    def forward(ctx, input, requant_scale, shift):               # ctx \u5fc5\u987b\u8981\n        input = input.double() * requant_scale / 2**shift        # \u4e3a\u4e86\u7b49\u4ef7\u4e8ec\u4e2d\u7684\u79fb\u4f4d\u64cd\u4f5c\u3002\u4f1a\u5b58\u5728int32\u6ea2\u51fa\n        input = torch.floor(input).float()\n\n        return torch.floor(input)\n    \n    @staticmethod\n    def symbolic(g, *inputs):\n        return g.op(\"Requant\", inputs[0], scale_f=23.0, shift_i=8)\n\nrequant_ = Requant_.apply\n\nclass TinyNet(nn.Module):\n    def __init__(self):\n        super(TinyNet, self).__init__()\n        self.conv1 = nn.Conv2d(3, 1, kernel_size=3, padding=1)\n        self.relu1 = nn.ReLU()\n        \n    def forward(self, x):\n        x = self.conv1(x)\n        x = self.relu1(x)\n        x = x.view(-1)\n        x = requant_(x, 5, 5)\n        return x\n\nnet = TinyNet().cuda()\nipt = torch.ones(2,3,12,12).cuda()\ntorch.onnx.export(net, (ipt,), 'tinynet.onnx', opset_version=11, enable_onnx_checker=False)\nprint(onnx.load('tinynet.onnx'))\n"})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"\u7ee7\u627f\u81eatorch.autograd"}),"\n",(0,o.jsx)(t.li,{children:"scale_f=23.0, shift_i=8\uff0c_f\u8868\u793a\u6d6e\u70b9\u6570\uff0c_i\u8868\u793a\u6574\u5f62int32\u7c7b\u578b"}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Alt text",src:e(901).Z+"",width:"843",height:"544"})})]})}function u(n={}){const{wrapper:t}={...(0,i.a)(),...n.components};return t?(0,o.jsx)(t,{...n,children:(0,o.jsx)(p,{...n})}):p(n)}},901:(n,t,e)=>{e.d(t,{Z:()=>o});const o=e.p+"assets/images/image-2-4e1b6f2eea3218fea142c0ef605f426c.png"},1151:(n,t,e)=>{e.d(t,{Z:()=>a,a:()=>r});var o=e(7294);const i={},s=o.createContext(i);function r(n){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function a(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),o.createElement(s.Provider,{value:t},n.children)}}}]);